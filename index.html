<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Application</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #scene-container {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    <img id="imgMarkerHiro" src="HIRO.jpg" style="display: none;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/examples/jsm/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/examples/jsm/webxr/ARButton.js"></script>
    <script>
        let camera, scene, renderer;
        let hiroMarkerMesh;

        init();

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.setAnimationLoop(render);
            renderer.xr.enabled = true;
            const container = document.querySelector('#scene-container');
            container.appendChild(renderer.domElement);

            const ambient = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            ambient.position.set(0.5, 1, 0.25);
            scene.add(ambient);

            const imgMarkerHiro = document.getElementById('imgMarkerHiro');
            const imgMarkerHiroBitmap = await createImageBitmap(imgMarkerHiro);
            const button = document.createElement('button');
            button.textContent = 'Enter AR';
            button.style.position = 'absolute';
            button.style.top = '10px';
            button.style.left = '10px';
            button.addEventListener('click', function () {
                if (imgMarkerHiroBitmap) {
                    renderer.xr.isPresenting ? renderer.xr.getSession().end() : renderer.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['image-tracking'],
                        optionalFeatures: ['dom-overlay'],
                        domOverlay: { root: document.body },
                        domOverlaySpace: renderer.xr.getReferenceSpace()
                    });
                }
            });
            document.body.appendChild(button);

            const hiroMarkerGeometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            hiroMarkerGeometry.translate(0, 0.1, 0);
            const hiroMarkerMaterial = new THREE.MeshNormalMaterial({
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            hiroMarkerMesh = new THREE.Mesh(hiroMarkerGeometry, hiroMarkerMaterial);
            hiroMarkerMesh.name = 'HiroMarkerCube';
            hiroMarkerMesh.matrixAutoUpdate = false;
            hiroMarkerMesh.visible = false;
            scene.add(hiroMarkerMesh);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function render(timestamp, frame) {
            const results = frame.getImageTrackingResults();
            console.log(results);
            for (const result of results) {
                const imageIndex = result.index;
                const referenceSpace = renderer.xr.getReferenceSpace();
                const pose = frame.getPose(result.imageSpace, referenceSpace);
                const state = result.trackingState;
                console.log(state);

                if (state === 'tracked') {
                    console.log('ImageIndex:', imageIndex);
                    if (imageIndex === 0) {
                        hiroMarkerMesh.visible = true;
                        hiroMarkerMesh.matrix.fromArray(pose.transform.matrix);
                        console.log('Hiro Image target has been found', hiroMarkerMesh.position);
                    }
                } else if (state === 'emulated') {
                    console.log('Image target no longer seen');
                }
            }
        }
    </script>
</body>
</html>
