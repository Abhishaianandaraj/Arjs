<!DOCTYPE html>
<html lang="en">

<head>
    <title>Basic Scene with Image Tracking</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.js"></script>
</head>

<body>
    <script type="module">
        let camera, scene, renderer;
        let mesh;

        async function init() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 40);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            var light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            const geometry = new THREE.IcosahedronGeometry(0.1, 1);
            const material = new THREE.MeshPhongMaterial({
                color: new THREE.Color("rgb(226,35,213)"),
                shininess: 6,
                flatShading: true,
                transparent: 1,
                opacity: 0.8
            });

            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            // Request XR Session with image tracking
            try {
                const img = document.getElementById('img');
                const imgBitmap = await createImageBitmap(img);
                const sessionInit = {
                    requiredFeatures: ['image-tracking'],
                    trackedImages: [
                        {
                            image: imgBitmap,
                            widthInMeters: 0.2
                        }
                    ]
                };
                const session = await navigator.xr.requestSession('immersive-ar', sessionInit);

                // Start tracking loop
                session.addEventListener('end', () => {
                    // Handle session end
                });
                session.requestAnimationFrame(onXRFrame);
            } catch (error) {
                console.error('Error starting XR session:', error);
            }
        }

        async function onXRFrame(timestamp, xrFrame) {
            const results = xrFrame.getImageTrackingResults();
            for (const result of results) {
                const imageIndex = result.index;
                const pose = xrFrame.getPose(result.imageSpace, xrFrame.session.referenceSpace);
                const state = result.trackingState;

                if (state == "tracked") {
                    // Image is actively tracked
                    // Update mesh position based on pose
                    mesh.position.copy(pose.transform.position);
                    mesh.quaternion.copy(pose.transform.orientation);
                    mesh.visible = true;
                } else if (state == "emulated") {
                    // Image is not actively tracked but was recently seen
                    // Adjust mesh visibility or position as needed
                    mesh.visible = false;
                }
            }

            // Continue tracking loop
            xrFrame.session.requestAnimationFrame(onXRFrame);
        }

        init();
    </script>

    <!-- Placeholder for the image to be tracked -->
    <img id="img" src="HIRO.jpg" style="display: none;">
</body>

</html>
